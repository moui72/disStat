---
title: "Inter-reading timing"
author: "Tyler Peckenpaugh"
date: "April 7, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(readr)
library(psych)
library(dplyr)
library(tidyr)
library(knitr)
library(lme4)
library(sjPlot)

raw_file <- read_csv("csvs/irt-rvad2.csv", 
  col_types = cols(
    Item = col_factor(levels = seq(1,48)), 
    Participant = col_character()
  )
)

raw_file$Participant <- as.factor(raw_file$Participant)
irt_data <- raw_file

irt_data$cond <- paste(
  ifelse(irt_data$Condition_Q,"+Q","-Q"),
  ifelse(
    irt_data$isFiller,
    ifelse(irt_data$Condition_GP,"+PP","-PP"),
    ifelse(irt_data$Condition_GP,"+GP","-GP")
  )
)

irt_data$Q <- ifelse(
  irt_data$Condition_Q,
  "+Q",
  "-Q"
)
irt_data$GP <- ifelse(
  irt_data$Condition_GP,
  "+GP",
  "-GP"
)
# P 8 is messed up
irt_data<-subset(irt_data,Participant != 8)
irt_props_all <- describe(irt_data$irt)
utl_props <- describe(append(irt_data$`R1 UL`,irt_data$`R2 UL`))
irt_data_all <- irt_data

# exclude 200 < IRTs > 25000
irt_min <- 500
irt_max <- 25000

irt_lo <- subset(irt_data, irt < irt_min)
irt_hi <- subset(irt_data, irt > irt_max)

irt_data <- subset(
  irt_data, 
  irt > irt_min & irt < irt_max & !isFiller
)

# winsorize top/bottom 5% of data (for normal distrbution, this is +/- 2sd)
# see: https://sciencing.com/relationship-between-standard-deviations-percentiles-8768703.html
win_trim=0.05
irt_data <- irt_data %>% group_by(Participant) %>% mutate(win_irt = winsor(irt, trim=win_trim))

# log 10 transform
irt_data$wirt.log10 <- log10(irt_data$win_irt)

# means by condition
meansByCondition <- aggregate(
  irt_data$win_irt,
  by=list(
    "Q"=irt_data$Q,
    "GP"=irt_data$GP
  ),
  FUN=mean
) %>% spread(Q,x) 
names(meansByCondition)[1] <- "Condition"
diffs<-list(Condition="Difference", `-Q`=diff(meansByCondition$`-Q`), `+Q`= diff(meansByCondition$`+Q`))
meansByCondition<-rbind(meansByCondition, diffs)
cdiff <- round(meansByCondition$`-Q`[3]-meansByCondition$`+Q`[3],1)

# participant means by condition
pmeansByCondition <- aggregate(
  irt_data$irt,
  by=list(
    "Condition"=irt_data$cond,
    "Participant"=irt_data$Participant
  ),
  FUN=mean
) %>% spread(Condition,x) 
pmeansByCondition$pattern <- (
  pmeansByCondition$`+Q +GP` - pmeansByCondition$`+Q -GP` <
  pmeansByCondition$`-Q +GP` - pmeansByCondition$`-Q -GP`
) 

# simple P means
spm <- aggregate(
  irt_data$irt,
  by=list(
    "Participant"=irt_data$Participant
  ),
  FUN=mean
) 
exclude_spm <- spm[spm$x>10000,]

irt_spmSplit <- subset(irt_data, !Participant %in% exclude_spm$Participant)

```

# Distribution of IRT

The raw IRTs are distributed as shown below.

```{r rawIRThist}
hist(irt_data_all$irt, breaks=80, xlab="IRT",main = "Raw IRT")
```

```{r zoomLft}
hist(subset(irt_data_all,irt<1000)$irt, breaks=20, xlab="IRT",main = "Left tail")
```
```{r zoomRgt}
hist(subset(irt_data_all,irt>20000)$irt, breaks=20, xlab="IRT",main = "Right tail")
```

IRTs below `r irt_min`ms (`r nrow(irt_lo)`) and above `r round(irt_max/1000,1)`s (`r nrow(irt_hi)`) are assumed to be implausible, and are omitted.

The data have also been Winsorized to bring data in the `r win_trim*100`th and `r 100-(100*win_trim)`th percentile of data to the value at those tresholds.

```{r winsorizedIRT}
hist(
  irt_data$win_irt, 
  breaks=80, 
  xlab="IRT",
  main = "Trimmed and Winsorized IRT"
)
```

Finally the remaining data have been subjected to a common log transform to elimnate some of the skew that is common for timing data.

```{r log10winsorizedIRT}
hist(
  irt_data$wirt.log10, 
  breaks=80, xlab="IRT",
  main = "Common log of Winsorized IRT"
)
```

# Means by condition

```{r mns}
kable(meansByCondition)
```

The relevant difference here is `r round(cdiff,1)`ms, which is in the direction that supports the hypothesis.

# Regression models

```{r lmeMod}

irt.full <- lmer(
  irt ~ Condition_Q * Condition_GP + 
    (1 | Participant) + 
    (1 | Item),
  data = irt_data,
  REML=F
)

irt.noInteraction <- lmer(
  irt ~ Condition_Q + Condition_GP + 
    (1 | Participant) + 
    (1 | Item),
  data = irt_data,
  REML=F
)

irt.noFxd <- lmer(
  irt ~
    (1 | Participant) + 
    (1 | Item),
  data = irt_data,
  REML=F
)
tab_model(irt.full,irt.noInteraction)
interaction <- anova(irt.full,irt.noInteraction)
```

# Regression models

```{r lmeMod-spmsplit}

irt.full <- lmer(
  win_irt ~ Condition_Q * Condition_GP + 
    (1 | Participant) + 
    (1 | Item),
  data = irt_spmSplit,
  REML=F
)

irt.noInteraction <- lmer(
  win_irt ~ Condition_Q + Condition_GP + 
    (1 | Participant) + 
    (1 | Item),
  data = irt_spmSplit,
  REML=F
)

irt.noFxd <- lmer(
  win_irt ~
    (1 | Participant) + 
    (1 | Item),
  data = irt_spmSplit,
  REML=F
)
tab_model(irt.full,irt.noInteraction)
interaction <- anova
tab_model(irt.full,irt.noFxd)
interaction <- anova(irt.full,irt.noFxd)
```

```{r pPattern}
kable(pmeansByCondition)
```

# Delay before cold readings
What follows is a description of the delay between the start of recording (i.e. a button press that transitioned the display from fixation screen to the sentence) until the onset of phonation. 
```{r howcold}
if (FALSE | !exists("rvad_raw")){
  rvad_raw <- read_csv("csvs/rvad-raw.csv", 
    col_types = cols(
      Item = col_character(), 
      Participant = col_character(), 
      Reading = col_character()
    )
  )
}
raw_r1s <- subset(rvad_raw,!isFiller & Reading=="1" & Leading < 10000)
des<-describe(raw_r1s$Leading)
```

In `r des$n` recordings of cold readings of experimental items (participant n = `r length(unique(raw_r1s$Participant))`; item n = 16; 14 data missing due to technical issues), the mean delay is `r round(des$mean,0)`ms (sd = `r round(des$sd,0)`). The longest delay, (one value longer than 10s was removed) is `r des$max` and the shortest is `r des$min`. The median is `r des$median`.
```{r coldhist}
hist(raw_r1s$Leading,breaks=80,xlab="Reading 1 delay",main="Only delays > 10s removed")

raw_r1s <- subset(rvad_raw,Reading=="1" & Leading < 4000)
hist(raw_r1s$Leading,breaks=80,xlab="Reading 1 delay",main="Delays > 4s removed")

hist(subset(raw_r1s, Leading < 1000)$Leading,breaks=80,xlab="Reading 1 delay",main="Zoom on < 1s (Left tail)",xlim=c(0,1000))
hist(subset(raw_r1s, Leading > 2500)$Leading,breaks=80,xlab="Reading 1 delay",main="Zoom on > 2.5s (Right tail)",xlim=c(2500,3600))
```

# Delay before previewed readings

What follows is a description of the delay between the start of recording of a second reading of a sentence (i.e. a button press that transitioned the display from an intermediate screen to the sentence) until the onset of phonation. 

```{r howprevs}
if (FALSE | !exists("rvad_raw")){
  rvad_raw <- read_csv("csvs/rvad-raw.csv", 
    col_types = cols(
      Item = col_character(), 
      Participant = col_character(), 
      Reading = col_character()
    )
  )
}
raw_r2s <- subset(rvad_raw,!isFiller & Reading=="2")
des<-describe(raw_r2s$Leading)
```

In `r des$n` recordings of previewed readings of experimental items (participant n = `r length(unique(raw_r1s$Participant))`; item n = 16; `r length(unique(raw_r1s$Participant))*16 - des$n` data missing due to technical issues), the mean delay is `r round(des$mean,0)`ms (sd = `r round(des$sd,0)`). The longest delay is `r round(des$max/1000,1)`s and the shortest is `r des$min`ms. The median is `r des$median`.

```{r prevhist}
hist(raw_r2s$Leading,breaks=80,xlab="Reading 2 delay",main="All data")
hist(subset(raw_r2s, Leading < 1000)$Leading,breaks=50,xlab="Reading 2 delay",main="Zoom on < 1s (Left tail)",xlim=c(0,1000))
hist(subset(raw_r2s, Leading > 10000)$Leading,breaks=50,xlab="Reading 2 delay",main="Zoom on > 10s (Right tail)")
```
